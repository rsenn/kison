<h2>open devtools console</h2>
<script type="module">
    import cal from './cal.js';
    import AstProcessor from './AstProcessor.js';


    (function () {
        function parseResult(input, options = {}, callback) {
            console.log('');
            console.log('***********************start ' + input);

            const ast = new AstProcessor();
            let ret;
            try {
                ret = cal.parse(input, {
                    onAction({ action, lexer }) {
                        action(ast, lexer);
                    },
                    ...options,
                });
            } catch (e) {
                console.error(e);
                console.log('***********************end ' + input);
                console.log('');
                return;
            }

            console.log('user ast stack', ast.stack);
            console.log('parse result', ret);
            if (ret.errorNode) {
                console.error(ret.errorNode.error.errorMessage);
            }
            console.log('parse tree', JSON.parse(JSON.stringify(ret.ast, null, 2)));
            callback && callback();
            console.log('***********************end ' + input);
            console.log('');
        }

        parseResult('1+2+3');

        parseResult('2*5+1');

        parseResult('1+2*5');

        
     

        parseResult('2^1^3');

        parseResult('(1+2)*5');
        parseResult('11+2*5');

        let input = '2+*3*+5';

        parseResult(input);

        let o = input;

        let arr = o.split('');
        let offset = 0;

        parseResult(input, {
            onErrorRecovery({ lexer, expected }, recommendAction) {
                if (recommendAction.action === 'add') {
                    arr.splice(offset + lexer.end, 0, '0');
                    offset + 1;
                    return {
                        action: 'add',
                        token: expected[0],
                        text: '0',
                    };
                } else if (recommendAction.action === 'del') {
                    arr.splice(offset + lexer.start, lexer.end - lexer.start);
                    offset -= lexer.end - lexer.start;
                    return {
                        action: 'del',
                    };
                }
            }
        }, () => {
            // error recovery: 2+*3*+5 => 2+3*5
            console.log(`after error recovery: ${o} => ${arr.join('')}`);
        });

        parseResult('1+2*');
    })();
</script>