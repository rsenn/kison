<h1>regexp in javascript</h1>

<h2>grammar</h2>

<div>
    regexp grammar <a href="./regexp-grammar.js">definition</a> and <a href="./diagram.xhtml">diagram</a>
</div>

<h2>build</h2>
<div>
    <pre>
    npx kison -m ll --es -g regexp-grammar.js
</pre>
</div>

<h2>install prebuild</h2>
<div>
    <pre>
        npm install @yiminghe/regexp
    </pre>
</div>

<div>
    <a href="./README.md">regexp readme</a>
</div>

<h2>open devtools console</h2>
<div>
    <textarea style="width:200px" id='input'>abzaaz</textarea>.match(/
    <input style="width:200px" id='pattern' value="(?<alternate>a|b)*(z)" />/);
    &nbsp; <input type="checkbox" id='g' checked>g</button>
    &nbsp; <input type="checkbox" id='caseInsensitive'>caseInsensitive</button>
    &nbsp; <input type="checkbox" id='multiline'>multiline</button>
    &nbsp; <input type="checkbox" id='dotMatchesLineSeparators'>dotMatchesLineSeparators</button>
    <br /> <br /> <button id='parseBtn'>parse</button>
    &nbsp; <button id='evaluate'>evaluate</button>
    &nbsp; <button id='evaluate2'>js native evaluate</button>
</div>

<h2>test case</h2>
<div>
    &nbsp; <button id='range'>range</button>
    &nbsp; <button id='lazy'>lazy</button>
    &nbsp; <button id='evil'>evil</button>
    &nbsp; <button id='backreference'>backreference</button>
    &nbsp; <button id='characterGroup'>characterGroup</button>
    &nbsp; <button id='lookahead'>lookahead</button>
    &nbsp; <button id='nagativeLookahead'>nagativeLookahead</button>
    &nbsp; <button id='lookbehind'>lookbehind</button>
    &nbsp; <button id='nagativeLookbehind'>nagativeLookbehind</button>
</div>

<script type="module">
    import { parse, compile } from './src/index.js';
    (function () {
        let currentText;
        let currentAst;

        function getAst(value) {
            if (currentText === value) {
                return currentAst;
            }
            console.log('parse ***********************', value);
            currentText = value;
            currentAst = parse(value);
            console.log(currentAst);
            if (currentAst.error) {
                console.error(currentAst.error.errorMessage);
            }
            console.log('***********************');
            return currentAst;
        }

        function $(id) {
            return document.getElementById(id);
        }

        const pattern = $('pattern');
        const input = $('input');
        const parseBtn = $('parseBtn');
        const evaluate = $('evaluate');
        const g = $('g');
        const evaluate2 = $('evaluate2');

        function getOptions() {
            return {
                caseInsensitive: $('caseInsensitive').checked,
                multiline: $('multiline').checked,
                dotMatchesLineSeparators: $('dotMatchesLineSeparators').checked,
            };
        }

        evaluate.addEventListener('click', () => {
            const start = Date.now();
            const patternInstance = compile(pattern.value);
            const options = getOptions();
            const matcher = patternInstance.matcher(input.value, options);
            let m;
            console.log('*********************** ' + input.value + '.match(/' + pattern.value + '/)');
            let ok;
            while (m = matcher.match()) {
                ok = true;
                console.log(m);
                if (!g.checked) {
                    break;
                }
            }
            if (!ok) {
                console.log('no match!!');
            }
            console.log('***********************', Date.now() - start);
            console.log('');
        });

        evaluate2.addEventListener('click', () => {
            const start = Date.now();
            let flag = 'g';
            const options = getOptions();
            if (options.multiline) {
                flag += 'm';
            }
            if (options.caseInsensitive) {
                flag += 'i';
            }
            if (options.dotMatchesLineSeparators) {
                flag += 's';
            }
            const reg = new RegExp(pattern.value, flag);
            const str = input.value;
            let m;
            console.log('*********************** js native:' + input.value + '.match(/' + pattern.value + '/)');
            let ok;
            while (m = reg.exec(str)) {
                ok = true;
                console.log(m);
                if (!g.checked) {
                    break;
                }
            }
            if (!ok) {
                console.log('no match!!');
            }
            console.log('***********************', Date.now() - start);
            console.log('');
        });

        range.addEventListener('click', () => {
            pattern.value = '(a|b){2,4}';
            input.value = 'ababab';
        });

        $('lazy').addEventListener('click', () => {
            pattern.value = 'a*?a';
            input.value = 'aaa';
        });

        $('evil').addEventListener('click', () => {
            pattern.value = '(a*)*c';
            input.value = 'a';
        });

        $('backreference').addEventListener('click', () => {
            pattern.value = '(a)b\\1';
            input.value = 'aba';
        });

        $('lookahead').addEventListener('click', () => {
            pattern.value = '(?=(a))(\\w)';
            input.value = 'aba';
        });
        $('nagativeLookahead').addEventListener('click', () => {
            pattern.value = '(?!(b))(\\w)';
            input.value = 'aba';
        });

        $('lookbehind').addEventListener('click', () => {
            pattern.value = '(?<=(b)(a))(\\w)';
            input.value = 'dbacbac';
        });

        $('nagativeLookbehind').addEventListener('click', () => {
            pattern.value = '(?<!(d)(b))(\\w)';
            input.value = 'dbacbac';
        });

        $('characterGroup').addEventListener('click', () => {
            pattern.value = '[1-9a.]';
            input.value = '222accbcc';
        });

        parseBtn.addEventListener('click', () => {
            currentText = undefined;
            getAst(pattern.value);
        }, false);
    })();
</script>

<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />

<a class="github-fork-ribbon" href="https://github.com/yiminghe/kison" data-ribbon="Fork me on GitHub"
    title="Fork me on GitHub">Fork me on GitHub</a>